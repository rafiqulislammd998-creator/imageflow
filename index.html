<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SecureVault Pro | Password & Note Manager</title>

    <!-- Fonts & icons (same as original) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Supabase client (kept inline as you requested no .env) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        /* ---------- Styles copied & lightly cleaned from original ---------- */
        :root {
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-glow: rgba(99, 102, 241, 0.4);
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
            --glass: rgba(30, 41, 59, 0.85);
            --glass-light: rgba(255, 255, 255, 0.05);
            --font-main: 'Poppins', sans-serif;
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --gradient-secondary: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: var(--font-main);
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 25%),
                radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.06) 0%, transparent 25%);
        }

        /* Particles (same as original) */
        .particles { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:1; }
        .particle { position:absolute; border-radius:50%; opacity:0.25; animation:float 20s infinite linear; }
        @keyframes float {
            0% { transform: translateY(0) translateX(0); }
            25% { transform: translateY(-100px) translateX(100px); }
            50% { transform: translateY(0) translateX(200px); }
            75% { transform: translateY(100px) translateX(100px); }
            100% { transform: translateY(0) translateX(0); }
        }

        /* AUTH SCREEN */
        #auth-screen {
            position: fixed; inset:0;
            background: rgba(15,23,42,0.98);
            backdrop-filter: blur(20px);
            z-index:10000;
            display:flex; align-items:center; justify-content:center;
            padding:20px;
            animation: fadeIn 0.8s ease;
        }
        .auth-container {
            background: var(--glass);
            padding: 50px 40px;
            border-radius: 30px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3), 0 0 100px rgba(99,102,241,0.06);
            max-width: 900px; width:100%;
            position: relative;
            z-index:2;
            backdrop-filter: blur(10px);
            overflow-y:auto;
            max-height:90vh;
        }
        .auth-brand { display:flex; align-items:center; gap:15px; margin-bottom:30px; }
        .auth-brand-icon { width:60px; height:60px; background:var(--gradient-primary); border-radius:20px; display:flex; align-items:center; justify-content:center; font-size:28px; color:white; }
        .auth-brand-text h1 { font-size:28px; font-weight:700; background: linear-gradient(135deg,var(--primary),var(--primary-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:4px; }
        .auth-tabs { display:flex; gap:10px; margin-bottom:25px; background: rgba(0,0,0,0.15); padding:6px; border-radius:12px; }
        .auth-tab { flex:1; padding:14px; border-radius:10px; background:none; border:none; color:var(--text-muted); font-weight:600; cursor:pointer; }
        .auth-tab.active { background:var(--gradient-primary); color:white; box-shadow:0 6px 18px rgba(99,102,241,0.18); transform: translateY(-2px); }

        .form-group { margin-bottom:18px; position:relative; }
        label { display:block; margin-bottom:8px; color:var(--text-main); font-weight:500; }
        .form-input { width:100%; padding:14px 18px; background: rgba(0,0,0,0.18); border-radius:12px; border:2px solid transparent; color:white; font-size:15px; }
        .form-input:focus { border-color:var(--primary); box-shadow: 0 0 0 6px rgba(99,102,241,0.06); }
        .input-icon { position:absolute; right:16px; top:50%; transform:translateY(-50%); color:var(--text-muted); }

        .btn { padding:14px 20px; border-radius:12px; border:none; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:10px; }
        .btn-primary { background:var(--gradient-primary); color:white; width:100%; }
        .auth-divider { display:flex; align-items:center; gap:10px; margin:18px 0; color:var(--text-muted); }
        .auth-footer { margin-top:18px; color:var(--text-muted); font-size:13px; }

        /* APP LAYOUT */
        .app-container { display:none; width:100%; max-width:1600px; margin:0 auto; min-height:100vh; }
        .sidebar { width:280px; background:var(--glass); padding:30px 20px; position:fixed; height:100vh; overflow-y:auto; border-right:1px solid var(--border); z-index:1000;}
        .brand { display:flex; align-items:center; gap:12px; font-size:22px; font-weight:700; margin-bottom:30px; }
        .nav-menu { list-style:none; padding:0; margin:0; }
        .nav-link { display:flex; align-items:center; gap:12px; padding:12px 10px; border-radius:12px; color:var(--text-muted); text-decoration:none; cursor:pointer; margin-bottom:8px; }
        .nav-link.active, .nav-link:hover { background: rgba(99,102,241,0.12); color:var(--primary); border:1px solid rgba(99,102,241,0.18); }

        .main-content { margin-left:280px; padding:30px; background:var(--bg-dark); min-height:100vh; }
        .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; gap:12px; flex-wrap:wrap; }
        .page-title h1 { font-size:24px; }
        .header-actions { display:flex; gap:10px; }

        /* Cards & lists */
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:20px; margin-bottom:20px; }
        .stat-card { background:var(--bg-panel); padding:18px; border-radius:12px; border:1px solid var(--border); display:flex; gap:12px; align-items:center; }
        .vault-container { background:var(--bg-panel); border-radius:12px; border:1px solid var(--border); overflow:hidden; margin-bottom:20px; }

        .vault-header { display:flex; justify-content:space-between; align-items:center; padding:14px; border-bottom:1px solid var(--border); gap:12px; }
        .search-box { display:flex; align-items:center; gap:10px; padding:10px 14px; border-radius:10px; background:rgba(0,0,0,0.12); width:300px; border:1px solid transparent; }
        .password-list { max-height:420px; overflow-y:auto; }
        .password-item { display:flex; justify-content:space-between; align-items:center; padding:14px; border-bottom:1px solid var(--border); cursor:pointer; }
        .item-info { display:flex; gap:12px; align-items:center; }
        .site-avatar { width:48px; height:48px; border-radius:10px; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#334155,#1e293b); color:var(--text-muted); font-weight:bold; border:1px solid var(--border); }

        .action-btn { width:40px; height:40px; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--text-muted); display:flex; align-items:center; justify-content:center; cursor:pointer; }
        .action-btn:hover { background:var(--primary); color:white; border-color:var(--primary); }

        .notes-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:18px; padding:18px; }
        .note-card { background:var(--bg-panel); border-radius:12px; padding:16px; border:1px solid var(--border); }

        /* modals */
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.85); display:none; z-index:2000; justify-content:center; align-items:center; padding:20px; }
        .modal-overlay.active { display:flex; animation:fadeIn .2s ease; }
        .modal-card { background:#0f1b2a; width:100%; max-width:560px; border-radius:12px; padding:20px; border:1px solid var(--border); max-height:90vh; overflow:auto; }

        /* toast */
        .toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(100px); background:var(--bg-panel); color:white; padding:10px 18px; border-radius:999px; border:1px solid var(--primary); display:flex; gap:8px; align-items:center; opacity:0; z-index:9999; transition:all .4s; }
        .toast.show { transform:translateX(-50%) translateY(0); opacity:1; }

        /* strength bar */
        .strength-bar-bg { width:100%; height:8px; background:rgba(255,255,255,0.04); border-radius:6px; margin-top:8px; overflow:hidden; }
        .strength-fill { height:100%; width:0%; background:var(--danger); transition:width .25s ease; }

        /* responsive */
        @media (max-width:992px) {
            .sidebar { transform: translateX(-100%); width:85%; max-width:320px; position:fixed; left:0; top:0; z-index:1001; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left:0; padding:18px; }
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen">
        <div class="auth-container">
            <div class="auth-brand">
                <div class="auth-brand-icon"><i class="fas fa-shield-virus"></i></div>
                <div class="auth-brand-text">
                    <h1>SecureVault Pro</h1>
                    <p style="color:var(--text-muted); font-size:13px;">Your digital security vault</p>
                </div>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
            </div>

            <div class="auth-message" id="auth-message" style="display:none;"></div>

            <form id="login-form" class="auth-form active">
                <div class="form-group">
                    <label for="login-email">Email Address</label>
                    <input type="email" id="login-email" class="form-input" placeholder="Enter your email" required>
                    <i class="fas fa-envelope input-icon"></i>
                </div>

                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" class="form-input" placeholder="Enter your password" required>
                    <i class="fas fa-lock input-icon"></i>
                    <button type="button" class="password-toggle" onclick="togglePassword('login-password')" aria-label="Toggle password" style="position:absolute; right:44px; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--text-muted);"> 
                        <i class="fas fa-eye"></i>
                    </button>
                </div>

                <div style="text-align:right; margin-bottom:18px;">
                    <a href="javascript:void(0)" onclick="showForgotPassword()" style="color:var(--primary); font-size:13px;">Forgot password?</a>
                </div>

                <button type="submit" class="btn btn-primary" id="login-btn"><span class="btn-text">Login to SecureVault</span></button>

                <div class="auth-divider" style="margin-top:16px;">
                    <span>New to SecureVault?</span>
                </div>

                <button type="button" class="btn" onclick="switchAuthTab('signup')" style="background:rgba(255,255,255,0.04); color:white; width:100%; margin-top:12px;">
                    <i class="fas fa-user-plus"></i> <span>Create New Account</span>
                </button>
            </form>

            <form id="signup-form" class="auth-form" style="display:none;">
                <div class="form-group">
                    <label for="signup-email">Email Address</label>
                    <input type="email" id="signup-email" class="form-input" placeholder="Enter your email" required>
                    <i class="fas fa-envelope input-icon"></i>
                </div>

                <div class="form-group">
                    <label for="signup-password">Create Password</label>
                    <input type="password" id="signup-password" class="form-input" placeholder="Minimum 8 characters" required>
                    <i class="fas fa-lock input-icon"></i>
                    <button type="button" class="password-toggle" onclick="togglePassword('signup-password')" style="position:absolute; right:44px; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--text-muted);">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>

                <div class="form-group">
                    <label for="confirm-password">Confirm Password</label>
                    <input type="password" id="confirm-password" class="form-input" placeholder="Re-enter your password" required>
                    <i class="fas fa-lock input-icon"></i>
                    <button type="button" class="password-toggle" onclick="togglePassword('confirm-password')" style="position:absolute; right:44px; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--text-muted);">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>

                <div class="form-group" style="margin-bottom:20px;">
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                        <input type="checkbox" id="terms-agreement" required style="accent-color:var(--primary);">
                        <span style="font-size:13px; color:var(--text-muted);">I agree to the <a href="javascript:void(0)" style="color:var(--primary)">Terms</a> & <a href="javascript:void(0)" style="color:var(--primary)">Privacy</a></span>
                    </label>
                </div>

                <button type="submit" class="btn btn-primary" id="signup-btn">Create Secure Account</button>

                <div class="auth-divider" style="margin-top:14px;">
                    <span>Already have an account?</span>
                </div>

                <button type="button" class="btn" onclick="switchAuthTab('login')" style="background:rgba(255,255,255,0.04); color:white; width:100%; margin-top:12px;">
                    <i class="fas fa-sign-in-alt"></i> Back to Login
                </button>
            </form>

            <form id="forgot-form" class="auth-form" style="display:none;">
                <div class="form-group">
                    <label for="forgot-email">Email Address</label>
                    <input type="email" id="forgot-email" class="form-input" placeholder="Enter your registered email" required>
                    <i class="fas fa-envelope input-icon"></i>
                </div>

                <p style="color:var(--text-muted); font-size:13px; margin-bottom:12px; text-align:center;">
                    Enter your email and we'll send a reset link.
                </p>

                <button type="submit" class="btn btn-primary" id="forgot-btn">Send Reset Link</button>

                <div class="auth-divider" style="margin-top:12px;">
                    <span>Remember your password?</span>
                </div>

                <button type="button" class="btn" onclick="switchAuthTab('login')" style="background:rgba(255,255,255,0.04); color:white; width:100%; margin-top:12px;">
                    <i class="fas fa-arrow-left"></i> Back to Login
                </button>
            </form>

            <div class="auth-footer" style="margin-top:18px;">
                <p>© 2024 SecureVault Pro. All rights reserved.</p>
                <p style="font-size:12px; opacity:0.7;"><i class="fas fa-lock"></i> Your data is encrypted end-to-end</p>
            </div>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="app-container" id="app-container" aria-hidden="true">
        <aside class="sidebar" id="sidebar">
            <button class="close-sidebar" onclick="toggleSidebar()" aria-label="Close sidebar" style="background:none; border:none; color:var(--text-muted); font-size:18px; padding:8px;">✕</button>
            <div class="brand"><i class="fas fa-shield-virus"></i>&nbsp; Secure<span style="color:var(--primary)">Vault</span></div>

            <ul class="nav-menu">
                <li><a class="nav-link active" onclick="switchView('dashboard')"><i class="fas fa-th-large"></i>&nbsp; Dashboard</a></li>
                <li><a class="nav-link" onclick="switchView('passwords')"><i class="fas fa-key"></i>&nbsp; Passwords</a></li>
                <li><a class="nav-link" onclick="switchView('notes')"><i class="fas fa-sticky-note"></i>&nbsp; Notes</a></li>
                <li><a class="nav-link" onclick="openGenerator()"><i class="fas fa-magic"></i>&nbsp; Generator</a></li>
                <li><a class="nav-link" onclick="handleExport()"><i class="fas fa-file-export"></i>&nbsp; Export</a></li>
            </ul>

            <div style="margin-top:auto; padding-top:20px; border-top:1px solid var(--border);">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div id="user-avatar" style="width:44px; height:44px; border-radius:50%; background:var(--secondary); display:flex; align-items:center; justify-content:center; font-weight:700;">U</div>
                        <div>
                            <div id="user-email" style="font-weight:600;">user@example.com</div>
                            <div style="font-size:12px; color:var(--text-muted);">Pro Member</div>
                        </div>
                    </div>
                    <button class="action-btn" onclick="logout()" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </aside>

        <main class="main-content" id="main-content" role="main">
            <div class="header">
                <div style="display:flex; align-items:center; width:100%;">
                    <button class="mobile-toggle" onclick="toggleSidebar()" aria-label="Open menu" style="display:none; background:none; border:none; color:var(--text-main); font-size:20px; margin-right:10px;"><i class="fas fa-bars"></i></button>
                    <div class="page-title" style="flex:1;">
                        <h1 id="page-heading">Dashboard Overview</h1>
                        <p id="page-sub" style="color:var(--text-muted); font-size:13px;">Welcome, your digital security is protected here.</p>
                    </div>
                </div>

                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openPasswordModal()"><i class="fas fa-plus"></i>&nbsp;Add Password</button>
                    <button class="btn" onclick="openNoteModal()" style="background:rgba(255,255,255,0.04); color:white;"><i class="fas fa-plus"></i>&nbsp;Add Note</button>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="view-dashboard">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div style="width:56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center; background:rgba(99,102,241,0.08); color:var(--primary);"><i class="fas fa-database"></i></div>
                        <div>
                            <h3 id="stat-total">0</h3>
                            <p style="color:var(--text-muted); font-size:13px;">Total Passwords</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div style="width:56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center; background:rgba(16,185,129,0.08); color:var(--success);"><i class="fas fa-sticky-note"></i></div>
                        <div>
                            <h3 id="stat-notes">0</h3>
                            <p style="color:var(--text-muted); font-size:13px;">Total Notes</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div style="width:56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center; background:rgba(239,68,68,0.08); color:var(--danger);"><i class="fas fa-exclamation-triangle"></i></div>
                        <div>
                            <h3 id="stat-weak">0</h3>
                            <p style="color:var(--text-muted); font-size:13px;">Weak Passwords</p>
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom:12px;">Recent Activity</h3>
                <div class="vault-container" id="recent-list" style="min-height:120px; padding:12px; color:var(--text-muted);">No recent activity</div>
            </div>

            <!-- Passwords view -->
            <div id="view-passwords" style="display:none;">
                <div class="vault-container">
                    <div class="vault-header">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input id="password-search" type="text" placeholder="Search passwords..." oninput="filterPasswords()" style="background:transparent; border:none; color:white; width:100%;" />
                        </div>
                        <span id="password-count" style="color:var(--text-muted); font-size:13px;">0 items</span>
                    </div>
                    <div class="password-list" id="password-list" style="padding:6px;"></div>
                </div>
            </div>

            <!-- Notes view -->
            <div id="view-notes" style="display:none;">
                <div class="vault-container">
                    <div class="vault-header">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input id="note-search" type="text" placeholder="Search notes..." oninput="filterNotes()" style="background:transparent; border:none; color:white; width:100%;" />
                        </div>
                        <span id="note-count" style="color:var(--text-muted); font-size:13px;">0 items</span>
                    </div>
                    <div class="notes-grid" id="notes-list"></div>
                </div>
            </div>

            <!-- Mobile actions (kept from original) -->
            <div class="mobile-actions" id="mobile-actions" style="display:none;">
                <button class="mobile-action-btn active" onclick="switchView('dashboard')"><i class="fas fa-th-large"></i><span>Dashboard</span></button>
                <button class="mobile-action-btn" onclick="switchView('passwords')"><i class="fas fa-key"></i><span>Passwords</span></button>
                <button class="mobile-action-btn" onclick="switchView('notes')"><i class="fas fa-sticky-note"></i><span>Notes</span></button>
                <button class="mobile-action-btn" onclick="openGenerator()"><i class="fas fa-magic"></i><span>Generator</span></button>
            </div>
        </main>

        <div class="mobile-fab" onclick="openPasswordModal()" style="position:fixed; right:20px; bottom:30px; width:60px; height:60px; border-radius:50%; background:var(--primary); display:flex; align-items:center; justify-content:center; font-size:22px; box-shadow:0 10px 30px rgba(99,102,241,0.4); z-index:900;">
            <i class="fas fa-plus"></i>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="modal-overlay" id="password-modal" aria-hidden="true">
        <div class="modal-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h2 id="password-modal-title">New Password</h2>
                <button onclick="closePasswordModal()" aria-label="Close" style="background:none; border:none; color:white; font-size:20px;">&times;</button>
            </div>

            <form id="password-form">
                <input type="hidden" id="password-id" value="">
                <div class="form-group">
                    <label>Website Name</label>
                    <input type="text" id="password-site" class="form-input" placeholder="e.g., Facebook" required>
                </div>

                <div class="form-group">
                    <label>Username / Email</label>
                    <input type="text" id="password-username" class="form-input" placeholder="user@example.com" required>
                </div>

                <div class="form-group">
                    <label>Password</label>
                    <div style="position:relative;">
                        <input type="password" id="password-value" class="form-input" required oninput="handleStrength(this.value)" placeholder="Enter password">
                        <button type="button" onclick="togglePassword('password-value')" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--primary); cursor:pointer;">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="strength-bar-bg"><div class="strength-fill" id="strength-bar"></div></div>
                    <div style="display:flex; justify-content:space-between; margin-top:8px;">
                        <span id="strength-text" style="font-size:13px; color:var(--text-muted);">Strength: Weak</span>
                        <button type="button" onclick="quickGenerate()" style="background:none; border:none; color:var(--primary); cursor:pointer;">Generate Strong</button>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width:100%;">Save Password</button>
            </form>
        </div>
    </div>

    <!-- Note Modal -->
    <div class="modal-overlay" id="note-modal" aria-hidden="true">
        <div class="modal-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h2 id="note-modal-title">New Note</h2>
                <button onclick="closeNoteModal()" aria-label="Close" style="background:none; border:none; color:white; font-size:20px;">&times;</button>
            </div>

            <form id="note-form">
                <input type="hidden" id="note-id" value="">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="note-title" class="form-input" placeholder="Note title" required>
                </div>

                <div class="form-group">
                    <label>Content</label>
                    <textarea id="note-content" class="form-input" placeholder="Write your note here..." rows="6" required></textarea>
                </div>

                <div class="form-group">
                    <label>Category (Optional)</label>
                    <input type="text" id="note-category" class="form-input" placeholder="e.g., Personal, Work, Ideas">
                </div>

                <button type="submit" class="btn btn-primary" style="width:100%;">Save Note</button>
            </form>
        </div>
    </div>

    <!-- Generator Modal -->
    <div class="modal-overlay" id="generator-modal" aria-hidden="true">
        <div class="modal-card">
            <h2 style="margin-bottom:12px;">Password Generator</h2>
            <div class="form-input" id="gen-preview" style="font-family:monospace; font-size:18px; text-align:center;">Generating...</div>

            <div class="form-group">
                <label>Length: <span id="len-val">16</span></label>
                <input type="range" id="gen-len" min="8" max="32" value="16" style="width:100%; accent-color:var(--primary);">
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px;">
                <label style="font-weight:500;"><input type="checkbox" id="inc-upper" checked> A-Z Uppercase</label>
                <label style="font-weight:500;"><input type="checkbox" id="inc-lower" checked> a-z Lowercase</label>
                <label style="font-weight:500;"><input type="checkbox" id="inc-num" checked> 0-9 Numbers</label>
                <label style="font-weight:500;"><input type="checkbox" id="inc-sym" checked> !@# Symbols</label>
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="generatePassword()" style="flex:1; background:rgba(255,255,255,0.04);">Refresh</button>
                <button class="btn btn-primary" onclick="copyGenerated()" style="flex:1;">Copy</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"><i class="fas fa-check-circle" style="color:var(--success)"></i><span id="toast-msg">Action successful!</span></div>

    <script>
        /* ========== SUPABASE SETUP (kept inline as requested) ========== */
        const SUPABASE_URL = 'https://bjwhairptrnvxtalojgx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqd2hhaXJwdHJudnh0YWxvamd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxODUwMzUsImV4cCI6MjA4MDc2MTAzNX0.BYp2kntMLoUTl6FITR_PNnrpihAvhlXqYNuf1JDHvqE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        /* ========== PARTICLES (cosmetic) ========== */
        function createParticles() {
            const container = document.getElementById('particles');
            const count = window.innerWidth < 768 ? 12 : 26;
            const colors = ['#6366f1', '#ec4899', '#10b981', '#f59e0b'];
            for (let i=0;i<count;i++){
                const el = document.createElement('div');
                el.className = 'particle';
                const size = Math.random()*12 + 6;
                el.style.width = `${size}px`; el.style.height = `${size}px`;
                el.style.left = `${Math.random()*100}%`;
                el.style.top = `${Math.random()*100}%`;
                el.style.background = colors[Math.floor(Math.random()*colors.length)];
                el.style.animationDelay = `${Math.random()*5}s`;
                container.appendChild(el);
            }
        }

        /* ========== UI STATE & HELPERS ========== */
        function showToast(msg, duration=3000) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            t.classList.add('show');
            setTimeout(()=> t.classList.remove('show'), duration);
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.style.display = 'none');
            document.querySelectorAll('.auth-tab').forEach(t => {
                if (t.textContent.toLowerCase().includes(tab)) t.classList.add('active');
            });
            const form = document.getElementById(`${tab}-form`);
            if (form) form.style.display = 'block';
            document.getElementById('auth-message').style.display = 'none';
            resetButtonStates();
        }

        function showForgotPassword() {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.style.display = 'none');
            document.getElementById('forgot-form').style.display = 'block';
        }

        function setButtonLoading(id, loading) {
            const btn = document.getElementById(id);
            if (!btn) return;
            if (loading) { btn.classList.add('btn-loading'); btn.disabled = true; }
            else { btn.classList.remove('btn-loading'); btn.disabled = false; }
        }
        function resetButtonStates() {
            ['login-btn','signup-btn','forgot-btn'].forEach(id => {
                const b = document.getElementById(id); if (b) { b.classList.remove('btn-loading'); b.disabled=false; }
            });
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function validatePassword(password) {
            if (!password || password.length < 8) return {valid:false, message:'Password must be at least 8 characters long'};
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasNum = /\d/.test(password);
            if (!(hasUpper && hasLower && hasNum)) return {valid:false, message:'Include uppercase, lowercase and numbers'};
            return {valid:true, message:'Password is strong'};
        }

        /* ========== AUTH HANDLERS ========== */
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            if (!email || !password) { showMessage('Please fill in all fields','error'); return; }
            if (!isValidEmail(email)) { showMessage('Enter a valid email','error'); return; }
            setButtonLoading('login-btn', true);
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) { showMessage('Login failed: ' + error.message,'error'); setButtonLoading('login-btn', false); }
                else {
                    showMessage('Login successful!','success');
                    setTimeout(()=>{ document.getElementById('auth-screen').style.display='none'; document.getElementById('app-container').style.display='flex'; document.getElementById('app-container').removeAttribute('aria-hidden'); updateUserInfo(data.user); loadDashboardData(); }, 600);
                }
            } catch (err) { showMessage('Login error','error'); setButtonLoading('login-btn', false); }
        });

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirm = document.getElementById('confirm-password').value;
            const terms = document.getElementById('terms-agreement').checked;
            if (!email || !password || !confirm) { showMessage('Please fill all fields','error'); return; }
            if (!isValidEmail(email)) { showMessage('Valid email required','error'); return; }
            const passCheck = validatePassword(password);
            if (!passCheck.valid) { showMessage(passCheck.message,'error'); return; }
            if (password !== confirm) { showMessage('Passwords do not match','error'); return; }
            if (!terms) { showMessage('You must agree to Terms','error'); return; }
            setButtonLoading('signup-btn', true);
            try {
                const { data, error } = await supabase.auth.signUp({ email, password, options:{ emailRedirectTo: window.location.origin }});
                if (error) { showMessage('Signup failed: '+error.message,'error'); setButtonLoading('signup-btn', false); }
                else { showMessage('Account created! Check email to verify.','success'); setButtonLoading('signup-btn', false); setTimeout(()=>{ switchAuthTab('login'); document.getElementById('login-email').value = email; }, 1500); }
            } catch(err) { showMessage('Signup error','error'); setButtonLoading('signup-btn', false); }
        });

        document.getElementById('forgot-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgot-email').value.trim();
            if (!email) { showMessage('Enter your email','error'); return; }
            if (!isValidEmail(email)) { showMessage('Enter a valid email','error'); return; }
            setButtonLoading('forgot-btn', true);
            try {
                const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + '/reset-password' });
                if (error) { showMessage('Error: '+error.message,'error'); setButtonLoading('forgot-btn', false); }
                else { showMessage('Reset link sent to your email','success'); setButtonLoading('forgot-btn', false); setTimeout(()=>switchAuthTab('login'), 2000); }
            } catch(err) { showMessage('Error sending reset link','error'); setButtonLoading('forgot-btn', false); }
        });

        function showMessage(text, type='success') {
            const el = document.getElementById('auth-message');
            el.textContent = text;
            el.className = 'auth-message ' + (type==='error'?'error':'success');
            el.style.display = 'block';
            if (type === 'success') setTimeout(()=> el.style.display='none', 5000);
        }

        async function logout() {
            await supabase.auth.signOut();
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('auth-screen').style.opacity = '1';
            showToast('Logged out');
        }

        function updateUserInfo(user) {
            if (!user) return;
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-avatar').textContent = user.email.charAt(0).toUpperCase();
        }

        /* ========== PASSWORDS & NOTES (local state + supabase) ========== */
        let passwords = [];
        let notes = [];

        // FETCH PASSWORDS
        async function fetchPasswords() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return [];
                const { data, error } = await supabase.from('passwords').select('*').eq('user_id', user.id).order('created_at',{ascending:false});
                if (error) { console.error(error); showToast('Error loading passwords'); return []; }
                passwords = data || [];
                return passwords;
            } catch (err) { console.error(err); return []; }
        }

        // SAVE PASSWORD (create/update)
        async function savePassword(passwordData) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) { showToast('Not authenticated'); return; }
                const { id, site, username, password, strength } = passwordData;
                const payload = {
                    user_id: user.id,
                    site_name: site,
                    username: username,
                    encrypted_password: password, // as requested: no encryption
                    strength: strength,
                    updated_at: new Date().toISOString()
                };
                let error;
                if (id) {
                    ({ error } = await supabase.from('passwords').update(payload).eq('id', id));
                } else {
                    ({ error } = await supabase.from('passwords').insert([payload]));
                }
                if (error) showToast('Error saving password: ' + error.message);
                else { showToast(id ? 'Password updated!' : 'Password saved!'); closePasswordModal(); await loadDashboardData(); if (document.getElementById('view-passwords').style.display !== 'none') renderPasswords(); }
            } catch(err) { console.error(err); showToast('Error saving password'); }
        }

        // DELETE PASSWORD
        async function deletePassword(id) {
            if (!confirm('Are you sure you want to delete this password?')) return;
            try {
                const { error } = await supabase.from('passwords').delete().eq('id', id);
                if (error) showToast('Error deleting: ' + error.message);
                else { showToast('Password deleted'); await loadDashboardData(); renderPasswords(); }
            } catch(err) { console.error(err); showToast('Delete error'); }
        }

        // FETCH NOTES
        async function fetchNotes() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return [];
                const { data, error } = await supabase.from('notes').select('*').eq('user_id', user.id).order('updated_at',{ascending:false});
                if (error) { console.error(error); showToast('Error loading notes'); return []; }
                notes = data || [];
                return notes;
            } catch(err) { console.error(err); return []; }
        }

        // SAVE NOTE
        async function saveNoteToDB(noteData) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) { showToast('Not authenticated'); return; }
                const { id, title, content, category } = noteData;
                const payload = { user_id: user.id, title, content, category: category || null, updated_at: new Date().toISOString() };
                let error;
                if (id) ({ error } = await supabase.from('notes').update(payload).eq('id', id));
                else ({ error } = await supabase.from('notes').insert([payload]));
                if (error) showToast('Error saving note: ' + error.message);
                else { showToast(id ? 'Note updated!' : 'Note saved!'); closeNoteModal(); await loadDashboardData(); if (document.getElementById('view-notes').style.display !== 'none') renderNotes(); }
            } catch(err) { console.error(err); showToast('Error saving note'); }
        }

        // DELETE NOTE
        async function deleteNoteFromDB(id) {
            if (!confirm('Delete this note?')) return;
            try {
                const { error } = await supabase.from('notes').delete().eq('id', id);
                if (error) showToast('Error deleting note: ' + error.message);
                else { showToast('Note deleted'); await loadDashboardData(); renderNotes(); }
            } catch(err) { console.error(err); showToast('Delete error'); }
        }

        /* ========== UI: switch views, sidebar ========== */
        function switchView(view) {
            ['dashboard','passwords','notes'].forEach(v => {
                const el = document.getElementById(`view-${v}`);
                if (el) el.style.display = 'none';
                const link = document.querySelector(`.nav-link[onclick*="${v}"]`);
                if (link) link.classList.remove('active');
            });
            document.getElementById(`view-${view}`).style.display = 'block';
            const activeLink = document.querySelector(`.nav-link[onclick*="${view}"]`);
            if (activeLink) activeLink.classList.add('active');

            document.getElementById('page-heading').textContent = view==='dashboard' ? 'Dashboard Overview' : view==='passwords' ? 'Password Vault' : 'Secure Notes';
            if (view==='passwords') renderPasswords();
            if (view==='notes') renderNotes();

            if (window.innerWidth < 992) toggleSidebar();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        /* ========== Load dashboard data & recent activity (FIXED spread bug) ========== */
        async function loadDashboardData() {
            const [passwordsData, notesData] = await Promise.all([fetchPasswords(), fetchNotes()]);
            document.getElementById('stat-total').textContent = (passwordsData || []).length;
            document.getElementById('stat-notes').textContent = (notesData || []).length;
            const weakCount = (passwordsData || []).filter(p => (p.strength==='weak') || (p.encrypted_password && p.encrypted_password.length < 8)).length;
            document.getElementById('stat-weak').textContent = weakCount;

            const merged = [
                ...(passwordsData || []).slice(0,3),
                ...(notesData || []).slice(0,3)
            ];
            const recent = merged.sort((a,b) => new Date(b.updated_at || b.created_at) - new Date(a.updated_at || a.created_at)).slice(0,5);

            const recentHtml = recent.map(item => {
                if (item.site_name) {
                    return `<div class="password-item">
                                <div class="item-info">
                                    <div class="site-avatar">${(item.site_name||'U').charAt(0).toUpperCase()}</div>
                                    <div class="site-details">
                                        <h4 style="margin:0 0 4px 0;">${escapeHtml(item.site_name)}</h4>
                                        <p style="margin:0; color:var(--text-muted);">${escapeHtml(item.username||'')}</p>
                                    </div>
                                </div>
                                <span style="font-size:12px; color:var(--text-muted);">Password</span>
                            </div>`;
                } else {
                    return `<div class="password-item">
                                <div class="item-info">
                                    <div class="site-avatar" style="background:var(--warning)">N</div>
                                    <div class="site-details">
                                        <h4 style="margin:0 0 4px 0;">${escapeHtml(item.title)}</h4>
                                        <p style="margin:0; color:var(--text-muted);">${escapeHtml(item.category || 'No category')}</p>
                                    </div>
                                </div>
                                <span style="font-size:12px; color:var(--text-muted);">Note</span>
                            </div>`;
                }
            }).join('');

            document.getElementById('recent-list').innerHTML = recentHtml || '<div style="padding:40px; text-align:center; color:var(--text-muted);">No recent activity</div>';
        }

        /* ========== Render Passwords & Notes (client) ========== */
        async function renderPasswords() {
            const passwordsData = await fetchPasswords();
            document.getElementById('password-count').textContent = `${(passwordsData||[]).length} items`;
            const html = (passwordsData || []).map(p => `
                <div class="password-item">
                    <div class="item-info" style="flex:1; cursor:pointer;" onclick="editPassword('${p.id}')">
                        <div class="site-avatar">${escapeHtml((p.site_name||'U').charAt(0).toUpperCase())}</div>
                        <div class="site-details" style="margin-left:10px;">
                            <h4 style="margin:0">${escapeHtml(p.site_name)}</h4>
                            <p style="margin:0; color:var(--text-muted); font-size:13px;">${escapeHtml(p.username)}</p>
                        </div>
                    </div>
                    <div class="item-actions" style="display:flex; gap:8px;">
                        <button class="action-btn" title="Copy password" onclick="copyToClipboard('${escapeAttr(p.encrypted_password||'')}')"><i class="fas fa-copy"></i></button>
                        <button class="action-btn" title="Edit" onclick="editPassword('${p.id}')"><i class="fas fa-pen"></i></button>
                        <button class="action-btn" title="Delete" style="color:var(--danger);" onclick="deletePassword('${p.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
            document.getElementById('password-list').innerHTML = html || '<div style="padding:40px; text-align:center; color:var(--text-muted);">No passwords yet</div>';
        }

        async function renderNotes() {
            const notesData = await fetchNotes();
            document.getElementById('note-count').textContent = `${(notesData||[]).length} items`;
            const html = (notesData || []).map(n => `
                <div class="note-card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <h4 style="margin:0">${escapeHtml(n.title)}</h4>
                        <div style="display:flex; gap:8px;">
                            <button class="action-btn" title="Edit" onclick="editNote('${n.id}')"><i class="fas fa-pen"></i></button>
                            <button class="action-btn" title="Delete" style="color:var(--danger)" onclick="deleteNoteFromDB('${n.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="note-card-content" style="color:var(--text-muted); margin-bottom:10px;">
                        <p style="margin:0;">${escapeHtml(n.content)}</p>
                    </div>
                    <div class="note-card-footer" style="display:flex; justify-content:space-between; color:var(--text-muted); font-size:12px;">
                        <div class="note-category">${escapeHtml(n.category || 'General')}</div>
                        <div>${new Date(n.updated_at || n.created_at || Date.now()).toLocaleString()}</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('notes-list').innerHTML = html || '<div style="padding:40px; text-align:center; color:var(--text-muted);">No notes yet</div>';
        }

        /* ========== Filter functions ========== */
        function filterPasswords() {
            const q = (document.getElementById('password-search').value || '').toLowerCase();
            document.querySelectorAll('.password-item').forEach(el => {
                const txt = el.innerText.toLowerCase();
                el.style.display = txt.includes(q) ? 'flex' : 'none';
            });
        }

        function filterNotes() {
            const q = (document.getElementById('note-search').value || '').toLowerCase();
            document.querySelectorAll('.note-card').forEach(el => {
                const txt = el.innerText.toLowerCase();
                el.style.display = txt.includes(q) ? 'block' : 'none';
            });
        }

        /* ========== Export data (as JSON download) ========== */
        async function handleExport() {
            const [pw, nt] = await Promise.all([fetchPasswords(), fetchNotes()]);
            const payload = { passwords: pw || [], notes: nt || [] };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(payload, null, 2));
            const a = document.createElement('a');
            a.setAttribute('href', dataStr);
            a.setAttribute('download', `securevault_export_${new Date().toISOString().slice(0,10)}.json`);
            document.body.appendChild(a);
            a.click();
            a.remove();
            showToast('Data exported successfully!');
        }

        /* ========== Generator / Password helpers (implemented) ========== */
        function generatePassword() {
            const len = parseInt(document.getElementById('gen-len').value,10) || 16;
            const incUpper = document.getElementById('inc-upper').checked;
            const incLower = document.getElementById('inc-lower').checked;
            const incNum = document.getElementById('inc-num').checked;
            const incSym = document.getElementById('inc-sym').checked;
            let pool = '';
            if (incUpper) pool += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            if (incLower) pool += 'abcdefghijklmnopqrstuvwxyz';
            if (incNum) pool += '0123456789';
            if (incSym) pool += '!@#$%^&*()_+-=[]{}|;:,.<>?';
            if (!pool) pool = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let out = '';
            for (let i=0;i<len;i++) out += pool.charAt(Math.floor(Math.random()*pool.length));
            document.getElementById('gen-preview').textContent = out;
        }

        function copyGenerated() {
            const text = document.getElementById('gen-preview').textContent || '';
            if (!text) { showToast('Nothing to copy'); return; }
            if (navigator.clipboard) navigator.clipboard.writeText(text).then(()=>showToast('Copied!')).catch(()=>showToast('Copy failed'));
            else { const ta = document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); showToast('Copied!'); }
        }

        document.getElementById('gen-len').addEventListener('input', function(){ document.getElementById('len-val').textContent = this.value; generatePassword(); });
        document.querySelectorAll('#generator-modal input[type="checkbox"]').forEach(cb => cb.addEventListener('change', generatePassword));

        function openGenerator() {
            generatePassword();
            document.getElementById('generator-modal').classList.add('active');
            document.getElementById('generator-modal').setAttribute('aria-hidden','false');
        }

        /* ========== Modal open/close helpers for password/note ========== */
        function openPasswordModal() {
            document.getElementById('password-id').value = '';
            document.getElementById('password-site').value = '';
            document.getElementById('password-username').value = '';
            document.getElementById('password-value').value = '';
            document.getElementById('strength-bar').style.width = '0%';
            document.getElementById('strength-text').textContent = 'Strength: Weak';
            document.getElementById('password-modal').classList.add('active');
            document.getElementById('password-modal').setAttribute('aria-hidden','false');
        }
        function closePasswordModal() {
            document.getElementById('password-modal').classList.remove('active');
            document.getElementById('password-modal').setAttribute('aria-hidden','true');
        }

        function openNoteModal() {
            document.getElementById('note-id').value = '';
            document.getElementById('note-title').value = '';
            document.getElementById('note-content').value = '';
            document.getElementById('note-category').value = '';
            document.getElementById('note-modal').classList.add('active');
            document.getElementById('note-modal').setAttribute('aria-hidden','false');
        }
        function closeNoteModal() {
            document.getElementById('note-modal').classList.remove('active');
            document.getElementById('note-modal').setAttribute('aria-hidden','true');
        }

        /* ========== Password strength helper (UI) ========== */
        function handleStrength(pass) {
            const bar = document.getElementById('strength-bar');
            const text = document.getElementById('strength-text');
            let score = 0;
            if (pass.length >= 8) score++;
            if (/[A-Z]/.test(pass)) score++;
            if (/[0-9]/.test(pass)) score++;
            if (/[@$!%*?&]/.test(pass)) score++;
            const widths = ['10%','35%','65%','90%'];
            const colors = ['var(--danger)','var(--warning)','var(--primary)','var(--success)'];
            const labels = ['Very Weak','Weak','Medium','Strong'];
            const idx = Math.max(0, Math.min(score-1, widths.length-1));
            bar.style.width = widths[Math.max(0, score-1)] || '10%';
            bar.style.background = colors[Math.max(0, score-1)] || 'var(--danger)';
            text.textContent = 'Strength: ' + (labels[Math.max(0, score-1)] || 'Very Weak');
        }

        /* quickGenerate used in password modal: */
        function quickGenerate() {
            const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*()";
            let pass = "";
            for (let i = 0; i < 12; i++) pass += chars.charAt(Math.floor(Math.random()*chars.length));
            document.getElementById('password-value').value = pass;
            handleStrength(pass);
        }

        /* Toggle password (single implementation) */
        function togglePassword(inputId) {
            const el = document.getElementById(inputId);
            if (!el) return;
            el.type = el.type === 'password' ? 'text' : 'password';
        }

        /* ========== Edit / Copy functions ========== */
        async function editPassword(id) {
            if (!id) return;
            // fetch single record
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) { showToast('Not authenticated'); return; }
            const { data, error } = await supabase.from('passwords').select('*').eq('id', id).single();
            if (error || !data) { showToast('Unable to fetch password'); return; }
            document.getElementById('password-id').value = data.id;
            document.getElementById('password-site').value = data.site_name || '';
            document.getElementById('password-username').value = data.username || '';
            document.getElementById('password-value').value = data.encrypted_password || '';
            handleStrength(data.encrypted_password || '');
            document.getElementById('password-modal').classList.add('active');
            document.getElementById('password-modal').setAttribute('aria-hidden','false');
        }

        function copyToClipboard(text) {
            if (!text) { showToast('Nothing to copy'); return; }
            if (navigator.clipboard) navigator.clipboard.writeText(text).then(()=>showToast('Copied to clipboard')).catch(()=>showToast('Copy failed'));
            else { const ta = document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); showToast('Copied'); }
        }

        async function editNote(id) {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) { showToast('Not authenticated'); return; }
            const { data, error } = await supabase.from('notes').select('*').eq('id', id).single();
            if (error || !data) { showToast('Unable to fetch note'); return; }
            document.getElementById('note-id').value = data.id;
            document.getElementById('note-title').value = data.title || '';
            document.getElementById('note-content').value = data.content || '';
            document.getElementById('note-category').value = data.category || '';
            document.getElementById('note-modal').classList.add('active');
            document.getElementById('note-modal').setAttribute('aria-hidden','false');
        }

        /* ========== Form submit handlers for password/note modals ========== */
        document.getElementById('password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                id: document.getElementById('password-id').value || null,
                site: document.getElementById('password-site').value.trim(),
                username: document.getElementById('password-username').value.trim(),
                password: document.getElementById('password-value').value,
                strength: document.getElementById('strength-text').textContent.includes('Strong') ? 'strong' : document.getElementById('strength-text').textContent.includes('Medium') ? 'medium' : 'weak'
            };
            if (!payload.site || !payload.username || !payload.password) { showToast('Fill all fields'); return; }
            await savePassword(payload);
        });

        document.getElementById('note-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                id: document.getElementById('note-id').value || null,
                title: document.getElementById('note-title').value.trim(),
                content: document.getElementById('note-content').value.trim(),
                category: document.getElementById('note-category').value.trim()
            };
            if (!payload.title || !payload.content) { showToast('Fill title and content'); return; }
            await saveNoteToDB(payload);
        });

        /* ========== Utility escaping helpers ========== */
        function escapeHtml(str='') {
            return String(str)
                .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
                .replaceAll('"','&quot;').replaceAll("'",'&#39;');
        }
        function escapeAttr(str='') { return escapeHtml(str).replaceAll('"','&quot;'); }

        /* ========== Init: check session, listeners, particles ========== */
        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            // session check
            supabase.auth.getSession().then(({ data:{ session } }) => {
                if (session) {
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-container').style.display = 'flex';
                    document.getElementById('app-container').removeAttribute('aria-hidden');
                    updateUserInfo(session.user);
                    loadDashboardData();
                }
            });
            // auth state listener
            supabase.auth.onAuthStateChange((event, session) => {
                if (session) {
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-container').style.display = 'flex';
                    updateUserInfo(session.user);
                    loadDashboardData();
                } else {
                    document.getElementById('app-container').style.display = 'none';
                    document.getElementById('auth-screen').style.display = 'flex';
                }
            });

            // demo button (for testing)
            const demoBtn = document.createElement('button');
            demoBtn.innerHTML = '<i class="fas fa-magic"></i> Try Demo';
            demoBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: var(--gradient-secondary);
                color: white;
                border: none;
                padding: 10px 14px;
                border-radius: 12px;
                cursor: pointer;
                z-index: 9999;
            `;
            demoBtn.onclick = async () => {
                // create demo user (only works in supabase if allowed)
                const demoEmail = 'demo+' + Date.now() + '@example.com';
                const demoPass = 'DemoPass123';
                try {
                    await supabase.auth.signUp({ email: demoEmail, password: demoPass });
                    showToast('Demo signup requested. Check email (if enabled).');
                } catch (err) {
                    console.warn(err);
                    showToast('Demo action failed');
                }
            };
            document.body.appendChild(demoBtn);
        });

        /* ========== Small fixes for UI accessibility ========== */
        // close modals when clicking overlay
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.classList.remove('active');
            });
        });

    </script>
</body>
</html>
